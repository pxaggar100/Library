import { DeleteResult, InsertOneResult, UpdateResult } from 'mongodb';
import { Book } from '../models/book';
import { collections } from '../database.js';
// eslint-disable-next-line @typescript-eslint/no-unused-vars
import getEmbeddings from '../embeddings/index.js';

class BookController {
    errors = {
        UNKNOWN_INSERT_ERROR: 'Unable to create book',
        UNKNOWN_UPDATE_ERROR: 'Unable to update book',
        UNKNOWN_DELETE_ERROR: 'Unable to delete book',
        NOT_FOUND: 'Book not found',
        DETAILS_MISSING: 'Book details are missing',
        BOOK_ID_MISSING: 'Book id is missing',
        ADMIN_ONLY: 'This operation is only allowed for admins',
        NOT_AVAILABLE: 'Book is not available'
    };

    success = {
        CREATED: 'Book created',
        UPDATED: 'Book updated',
        DELETED: 'Book deleted'
    };

    public async getBooks(limit: number = 12, skip: number = 0): Promise<Book[]> {
        if (limit > 100) {
            limit = 100;
        }

        const bookCursor = collections?.books?.find({});
        const books = await bookCursor.limit(limit).skip(skip).toArray();

        return books;
    }

    public async getBook(bookId: string): Promise<Book> {
        /**
         * Initial Code
         * Task: Optimise the query to take advantage of the already computed field.
         * Hint: Take a look at the shape of the Book documents using MongoDB Compass.
         */
        const books = await collections?.books?.aggregate<Book>([
            {
                $match: {
                    _id: bookId
                },
            },
            {
                $lookup: {
                    from: 'issueDetails',
                    localField: '_id',
                    foreignField: 'book._id',
                    pipeline: [
                        {
                            $match: {
                                $or: [
                                    { recordType: 'reservation' },
                                    { recordType: 'borrowedBook', returned: false }
                                ]
                            }
                        }
                    ],
                    as: 'details'
                }
            },
            {
                $set: {
                    available: {
                        $subtract: ['$totalInventory', { $size: '$details' }]
                    }
                }
            },
            {
                $unset: 'details'
            },
        ]).toArray();

        if (!books?.length) {
            return;
        }

        return books[0];
    }

public async searchBooks(query: string): Promise<Book[]> {
  const aggregationPipeline = [
    {
      $vectorSearch: {
        queryVector:  
 [
    -0.0174162965 ,  0.0245774388 ,  -0.0101664858 ,  0.015426904 ,  -0.00415589521 ,  0.000379170029 ,  0.00328788417 ,  0.0232018214 ,  0.0125158112 ,  0.0160533246 ,  -0.00541570364 ,  0.0105888518 ,  -0.00495141745 ,  0.00877464749 ,  -0.00066192291 ,  -0.0279761553 ,  0.00479448168 ,  0.00526619935 ,  0.0137019875 ,  0.0112587586 ,  -0.0164364669 ,  0.00324318558 ,  -0.00365074654 ,  0.00283526955 ,  0.0249142349 ,  -0.000715848873 ,  -0.0189171676 ,  -0.000722481229 ,  0.00902813487 ,  -0.0158262141 ,  0.00499641569 ,  0.0144984741 ,  0.0185688455 ,  0.0219901353 ,  -0.0337887295 ,  -0.00138517399 ,  0.0149789844 ,  -0.0011123264 ,  -0.0220389366 ,  0.00396383693 ,  -0.00816524867 ,  0.0165361371 ,  0.0000103136945 ,  0.00915649 ,  -0.00743202539 ,  0.00258577825 ,  -0.0010407283 ,  -0.013722592 ,  0.0265785698 ,  0.0116659962 ,  -0.0044687083 ,  -0.0170654096 ,  0.0090931775 ,  0.0182800591 ,  -0.00480159 ,  -0.0223153941 ,  -0.0149503266 ,  0.00384669541 ,  0.00747237448 ,  0.00374067528 ,  -0.0029205468 ,  0.00429578731 ,  -0.00466444204 ,  0.00285394932 ,  -0.00742075406 ,  0.00319738523 ,  0.00445757806 ,  -0.0183825158 ,  -0.0038325619 ,  0.00428729085 ,  0.0102414265 ,  -0.00895938464 ,  0.00405489327 ,  -0.00223220978 ,  -0.0142137855 ,  0.0128879305 ,  0.00182934839 ,  -0.0129079223 ,  -0.0109607885 ,  -0.00286891381 ,  -0.00816109776 ,  0.0042261472 ,  -0.0138018392 ,  0.00879025646 ,  -0.0275858473 ,  0.0199074782 ,  0.00278126402 ,  0.00318450946 ,  0.00392502174 ,  0.0032763998 ,  0.00577079458 ,  0.0109967645 ,  0.0241964459 ,  -0.00249635172 ,  -0.0277098026 ,  -0.0112264836 ,  0.00543002551 ,  -0.0060945563 ,  0.00533928443 ,  0.00700696697 ,  -0.00443158392 ,  0.0266380236 ,  0.0052870675 ,  0.00181362615 ,  -0.00063150574 ,  -0.010961365 ,  0.00454009417 ,  0.00301212608 ,  0.0146357827 ,  0.00371428649 ,  -0.0144161526 ,  0.00273155351 ,  -0.00169123092 ,  -0.00276259822 ,  0.00441844296 ,  0.013464313 ,  0.0272840764 ,  0.0103263296 ,  -0.00747303572 ,  0.0177887678 ,  0.0138310278 ,  0.000284288137 ,  -0.0100040426 ,  0.00991517305 ,  -0.0158022288 ,  -0.00863224082 ,  0.00715725124 ,  0.0218035821 ,  -0.0120832948 ,  0.0068402607 ,  0.00545122242 ,  -0.00650596293 ,  0.0155197401 ,  0.00771469343 ,  0.0214803 ,  -0.0148789957 ,  0.0286776777 ,  -0.00362978922 ,  -0.0171407629 ,  0.00785124 ,  0.00237989728 ,  0.0161630642 ,  0.0101449694 ,  -0.00741708232 ,  0.00798536651 ,  0.00452013081 ,  0.0103888111 ,  -0.014011967 ,  0.0311738066 ,  -0.00891176 ,  -0.00529846037 ,  -0.00671822391 ,  0.00301906583 ,  -0.0069941 ,  0.0188662242 ,  -0.000790660677 ,  0.00393483834 ,  -0.00165903952 ,  -0.00847951416 ,  0.00668279501 ,  0.0161590427 ,  -0.0146305244 ,  -0.00464632642 ,  -0.0056685 ,  0.0330115482 ,  0.0111305835 ,  0.0302436613 ,  -0.0116894422 ,  -0.00270438148 ,  0.0285141747 ,  -0.00717114331 ,  -0.0167590193 ,  0.00485714804 ,  0.00388671015 ,  -0.00185622601 ,  0.0241311342 ,  -0.00222511846 ,  -0.00568641163 ,  0.00082476 ,  0.00102514261 ,  0.007614817 ,  0.0115251541 ,  0.0115654282 ,  0.0149287824 ,  -0.0142699759 ,  0.00305828 ,  0.0107790576 ,  -0.0271064173 ,  -0.000438057235 ,  0.0149125801 ,  -0.00570692122 ,  0.019790316 ,  0.00523369899 ,  0.0157233402 ,  0.0194497723 ,  0.00828364 ,  0.0261637885 ,  -0.00106777356 ,  -0.00172611733 ,  0.0210740175 ,  0.0108330827 ,  0.00277128536 ,  0.0154189626 ,  0.00658144709 ,  0.0123065403 ,  -0.0227006748 ,  -0.0146393012 ,  0.00505430065 ,  -0.0153992195 ,  0.0292910989 ,  0.0130359642 ,  -0.00779962493 ,  0.0139949955 ,  -0.0134135196 ,  0.0225379467 ,  0.0151461326 ,  0.00695634028 ,  -0.0024139965 ,  -0.017798746 ,  -0.0196874235 ,  -0.0325383283 ,  0.0160800312 ,  0.0121088177 ,  -0.00885253772 ,  0.0105135813 ,  -0.00632725563 ,  0.044731766 ,  0.0135601694 ,  0.0155309541 ,  0.0211559199 ,  0.0178867057 ,  0.00488560786 ,  -0.0240100455 ,  0.00487437192 ,  -0.0041149091 ,  0.00257139071 ,  0.0196579695 ,  0.0150385257 ,  0.0177825782 ,  0.0153155597 ,  0.00475977128 ,  0.00158851594 ,  0.00595198805 ,  0.00178528065 ,  -0.00435770303 ,  -0.0140293073 ,  -0.0239157584 ,  0.0202592406 ,  -0.00880476646 ,  0.00874939 ,  0.0148269385 ,  0.00226395833 ,  0.0113797877 ,  0.0148496982 ,  0.000981716905 ,  0.00161507656 ,  -0.0109435441 ,  -0.00667641591 ,  0.0344219916 ,  0.0372289196 ,  -0.0129976077 ,  0.027455451 ,  -0.0101687554 ,  0.0184402447 ,  0.00000160684897 ,  0.00839170348 ,  -0.00304720737 ,  -0.00501035852 ,  0.0013040686 ,  0.0286810193 ,  -0.00165785092 ,  -0.00896887481 ,  0.014901435 ,  -0.00864635594 ,  0.0140394829 ,  0.0160239 ,  0.0303953737 ,  -0.0108761434 ,  0.0209692623 ,  0.00971899368 ,  -0.00486202398 ,  -0.00106382929 ,  0.0157670155 ,  0.0185049102 ,  -0.000125856968 ,  0.016272841 ,  0.00143731432 ,  -0.0148587143 ,  -0.00194294413 ,  -0.00134741853 ,  -0.0215529297 ,  0.00967474747 ,  0.004122396 ,  -0.000132224464 ,  0.0288606416 ,  0.0107908072 ,  0.00210265 ,  0.0247537829 ,  -0.00562974578 ,  -0.0163796097 ,  -0.0172648821 ,  0.0059145228 ,  -0.00990151428 ,  -0.0134067796 ,  -0.00594962807 ,  0.0168949831 ,  -0.0162620917 ,  -0.0118620684 ,  0.00665928749 ,  0.0104725547 ,  -0.0263601895 ,  -0.00030892287 ,  0.0131708058 ,  0.0205616262 ,  0.0193500519 ,  -0.00274952711 ,  0.0265398808 ,  0.00813123 ,  0.00141490332 ,  -0.00281327404 ,  -0.00459163031 ,  -0.00336960121 ,  0.00627432717 ,  -0.00115516654 ,  0.0324379057 ,  0.00233021169 ,  -0.0084840795 ,  0.0193278417 ,  -0.00452532293 ,  0.00359316729 ,  -0.00484369043 ,  -0.0124026937 ,  0.00538760144 ,  0.00616242364 ,  0.0164079089 ,  -0.00219628913 ,  0.013533229 ,  0.0132479165 ,  0.0189592596 ,  0.0126596289 ,  -0.0216388721 ,  0.0176775195 ,  -0.00595868705 ,  0.0174865779 ,  -0.027499225 ,  -0.00467659533 ,  -0.00849458296 ,  0.0136932498 ,  -0.0112622883 ,  0.00561642693 ,  0.000294685509 ,  0.00167854887 ,  -0.00100786611 ,  0.00122261653 ,  0.011614399 ,  0.0204342 ,  -0.0117546692 ,  0.00602791319 ,  0.00254450296 ,  0.0116753969 ,  -0.00492580514 ,  0.00670228619 ,  0.00524263503 ,  0.0359221213 ,  -0.00650785957 ,  -0.00342567032 ,  0.000238710738 ,  -0.0144591732 ,  -0.0180309769 ,  0.000703251222 ,  0.0179406367 ,  -0.0121124517 ,  0.00484898081 ,  -0.0129846008 ,  -0.0121382745 ,  0.0298236441 ,  0.00660934439 ,  0.00802135468 ,  -0.0147326291 ,  0.00721890526 ,  0.0268558953 ,  0.00417125644 ,  -0.00530042592 ,  -0.00102057308 ,  0.00427180901 ,  0.0162123423 ,  -0.0158268809 ,  0.0016410104 ,  0.00358636281 ,  0.0103789438 ,  -0.0373012312 ,  -0.0167543553 ,  0.00789179094 ,  -0.00651058787 ,  -0.00101554592 ,  -0.00974304695 ,  -0.00131745555 ,  0.0105802603 ,  0.0131299524 ,  -0.00679483218 ,  -0.00871113222 ,  0.0147298109 ,  0.00825089682 ,  0.00596718257 ,  0.0023834582 ,  0.0152730308 ,  0.0268712863 ,  0.0115540912 ,  -0.0034172642 ,  -0.00113652134 ,  0.0076234513 ,  0.0187208131 ,  -0.00650485698 ,  0.000535065075 ,  0.0165142342 ,  0.0018421209 ,  -0.249476731 ,  -0.00826251786 ,  -0.00227547437 ,  -0.01809109 ,  -0.013197042 ,  0.0037673153 ,  0.0365200639 ,  0.00140378659 ,  0.0111682555 ,  -0.00212278054 ,  0.00192302209 ,  0.00551756844 ,  0.00918013416 ,  0.0016007123 ,  0.00283389539 ,  0.0198921915 ,  0.00813968293 ,  0.000216852786 ,  -0.0105159897 ,  0.00775925955 ,  0.0125824884 ,  0.0122032613 ,  0.0271087475 ,  -0.237329781 ,  -0.0091460431 ,  0.0316801593 ,  0.011309783 ,  0.0148321288 ,  0.0164116453 ,  0.00588332955 ,  0.00802596472 ,  0.0076354132 ,  -0.00110252993 ,  0.00436541392 ,  -0.0034002536 ,  -0.00814347249 ,  -0.0100771571 ,  0.000550651457 ,  -0.0175937749 ,  -0.00430326303 ,  0.00681335293 ,  0.00399685185 ,  0.00380431511 ,  0.00233724923 ,  -0.00215457822 ,  0.00195491593 ,  0.0162788294 ,  -0.00570913265 ,  0.000231042519 ,  0.00515314238 ,  0.0150186466 ,  -0.00307800807 ,  -0.0198503546 ,  0.014186522 ,  0.0174691118 ,  -0.249346316 ,  -0.0132391 ,  0.0147329448 ,  -0.00133319933 ,  0.0165803097 ,  0.00463585882 ,  0.0113709606 ,  0.008648647 ,  -0.0157090388 ,  -0.0161941145 ,  0.0260536075 ,  0.0115038939 ,  0.0175996292 ,  0.0117571149 ,  0.0102994246 ,  0.00593641959 ,  -0.0208111256 ,  0.00133263832 ,  0.010016934 ,  -0.00106800569 ,  0.0136044649 ,  0.0122899665 ,  0.0123574333 ,  -0.0159868691 ,  -0.00883269496 ,  -0.0105052972 ,  -0.0153602259 ,  -0.00708895084 ,  -0.00374335726 ,  -0.00516681513 ,  -0.0135211078 ,  0.0079748584 ,  0.00592072774 ,  0.00657905731 ,  0.00537452195 ,  0.0105388239 ,  0.00773322256 ,  -0.00987939443 ,  -0.0255899932 ,  0.0052358415 ,  -0.0246183649 ,  -0.011944456 ,  -0.00988268107 ,  -0.00565451337 ,  0.0147379646 ,  0.00744351419 ,  0.00927754212 ,  0.00380466622 ,  0.0037476616 ,  0.0092136357 ,  -0.0178595334 ,  0.00654375087 ,  0.00677238265 ,  0.0119226445 ,  0.0140760075 ,  0.0101927957 ,  0.0223148279 ,  -0.00858868565 ,  0.012999041 ,  -0.0150532462 ,  0.0109934555 ,  0.00686802063 ,  0.0031152619 ,  -0.00473426143 ,  0.000165670586 ,  0.00571797 ,  0.00903102383 ,  0.0144805517 ,  0.0254828241 ,  0.0119039025 ,  0.0119439596 ,  0.0103861969 ,  0.00474035135 ,  -0.0117407953 ,  0.0022234011 ,  -0.0240126532 ,  0.00195854483 ,  -0.00518661272 ,  0.019946482 ,  -0.00267217122 ,  0.009945862 ,  0.0190599672 ,  0.0397237316 ,  0.0202055052 ,  -0.0139578842 ,  0.0060266573 ,  0.00725419354 ,  -0.00301874289 ,  0.00148249371 ,  0.0024454135 ,  0.00820134301 ,  -0.00378446095 ,  0.0234579109 ,  -0.0033848444 ,  0.00254337443 ,  0.0135972723 ,  0.00937160477 ,  -0.00909276493 ,  0.00130138954 ,  -0.00247958838 ,  -0.00518678408 ,  0.0116308825 ,  -0.00553699303 ,  0.00865344424 ,  -0.0209188387 ,  0.0284014959 ,  0.0397592895 ,  0.0571159609 ,  0.0189767536 ,  -0.023579834 ,  -0.00844216067 ,  0.0269133598 ,  -0.00793308951 ,  0.0179536212 ,  0.0059208381 ,  0.0267210901 ,  -0.00665957062 ,  -0.00739492057 ,  0.000611711 ,  -0.0111742681 ,  -0.0088798441 ,  0.0142433736 ,  -0.00675414363 ,  -0.013581289 ,  0.0119962124 ,  -0.00928197522 ,  -0.00478880247 ,  0.00416102679 ,  0.0038893742 ,  0.0427196696 ,  0.0131726274 ,  -0.0123320194 ,  0.00407074625 ,  0.0157892872 ,  -0.00405432237 ,  0.0148664955 ,  0.000984201324 ,  0.00735353632 ,  0.00236657821 ,  0.0131964013 ,  0.0166589823 ,  0.00707848091 ,  -0.0027406693 ,  0.00459480798 ,  0.0105721094 ,  0.038077537 ,  -0.00724895485 ,  0.0128929093 ,  0.0175121538 ,  -0.00665202318 ,  -0.247710422 ,  0.00593931973 ,  -0.0173492823 ,  -0.203771278 ,  0.022104552 ,  0.0050284192 ,  0.0160764456 ,  0.016262304 ,  -0.0205290765 ,  0.0136162154 ,  0.00742666796 ,  0.00876677874 ,  0.0114127081 ,  0.0416617617 ,  -0.00927854702 ,  0.0112848505 ,  0.0178707372 ,  -0.00223326334 ,  0.0115998704 ,  0.00727966847 ,  -0.0224510189 ,  0.0249368027 ,  0.0238542352 ,  -0.0146937314 ,  -0.0209311862 ,  -0.00717318663 ,  0.0110357357 ,  -0.00295578293 ,  0.0181849543 ,  0.00753912888 ,  0.0042518219 ,  -0.00561797433 ,  -0.00504555972 ,  0.0107642859 ,  0.0177009478 ,  0.00762712 ,  0.0197622236 ,  0.00996106863 ,  0.0102393087 ,  -0.000226532284 ,  0.00431017531 ,  0.00471323589 ,  -0.00553298509 ,  -0.00104342133 ,  0.00330404961 ,  0.00767560164 ,  0.0136543792 ,  0.00799431466 ,  -0.0267019328 ,  0.00330304564 ,  0.00223713531 ,  -0.0070342035 ,  0.00321111432 ,  0.00481710536 ,  0.00400120579 ,  -0.00364657654 ,  0.00713134604 ,  0.00183409965 ,  0.0146055343 ,  0.00995466858 ,  -0.00987416 ,  0.0178020764 ,  -0.00410982594 ,  -0.00375419459 ,  -0.00325361406 ,  -0.00651473925 ,  0.004713431 ,  -0.0153508792 ,  -0.0185174402 ,  -0.00903706253 ,  -0.0126047824 ,  0.0033940461 ,  0.000134488277 ,  -0.00378203602 ,  0.0171301793 ,  -0.00948834792 ,  0.0229860656 ,  0.0204468649 ,  0.0309519116 ,  -0.0137306936 ,  0.0127609968 ,  0.00304349489 ,  -0.00848938338 ,  0.000456935231 ,  -0.00419570133 ,  -0.0183459539 ,  0.0126175517 ,  0.0170864258 ,  -0.00714809308 ,  -0.00622619689 ,  -0.00646926463 ,  0.00463462481 ,  -0.00598485954 ,  0.0058905771 ,  -0.00532265846 ,  0.00814901479 ,  -0.00345747569 ,  0.00700392434 ,  0.00343142869 ,  -0.00116848084 ,  -0.00112342311 ,  0.00955636241 ,  0.00373206171 ,  -0.0109822154 ,  0.00771702081 ,  -0.0189748686 ,  0.00980147719 ,  -0.00591509324 ,  0.0076705208 ,  0.0394647382 ,  0.0115754018 ,  0.0143392934 ,  0.0000282846286 ,  0.0113825127 ,  0.0137632713 ,  0.011303287 ,  -0.0120392628 ,  0.00527257239 ,  -0.01770005 ,  -0.0211959593 ,  0.00266567105 ,  0.0137595497 ,  0.0152906533 ,  0.00961258076 ,  0.00359264831 ,  0.00661252718 ,  0.00695862202 ,  -0.0026560782 ,  -0.00485670427 ,  -0.0139870541 ,  -0.000298133207 ,  0.0239104815 ,  0.00129168539 ,  0.000877773913 ,  0.00655013742 ,  0.0215926971 ,  -0.0083441427 ,  -0.0110250823 ,  -0.0227467511 ,  -0.00535951043 ,  -0.0152951283 ,  0.0261800103 ,  0.00358167547 ,  0.00995154399 ,  0.0208249036 ,  -0.00415720558 ,  0.0102396579 ,  0.00937197078 ,  0.0101401098 ,  0.0162998606 ,  -0.00591357565 ,  -0.00123272289 ,  -0.00332033541 ,  0.0252272952 ,  0.0071680313 ,  0.00495454436 ,  0.0116113769 ,  0.0884006843 ,  0.0106528541 ,  0.0191799905 ,  0.00955921505 ,  0.00730522443 ,  0.0124047017 ,  0.00439803209 ,  -0.00646532886 ,  0.0221869014 ,  -0.00383959105 ,  -0.00633799238 ,  -0.00244529778 ,  0.0185070243 ,  0.00660874508 ,  0.000933621894 ,  0.0225343518 ,  -0.000844085938 ,  -0.0189829767 ,  0.0178090725 ,  0.0259044357 ,  0.0013883377 ,  0.0267268326 ,  0.0166377965 ,  0.0123627633 ,  0.0018634533 ,  0.00947038 ,  0.011571574 ,  0.0193832647 ,  -0.00982086919 ,  0.00155755156 ,  0.0129259815 ,  0.00136097835 ,  -0.00877885893 ,  0.0131311752 ,  -0.00151362107 ,  0.00834575202 ,  0.00050025346 ,  0.00319283199 ,  0.00782897323 ,  0.000716953946 ,  0.016656056 ,  0.0286584031 ,  -0.0176211428 ,  0.0118140755 ,  0.00854969304 ,  0.0290862173 ,  0.0170480814 ,  -0.00587001676 ,  -0.00909367 ,  0.00177566044 ,  0.016940793 ,  -0.00799633469 ,  -0.00553826662 ,  -0.000856186845 ,  -0.00895845331 ,  0.017707251 ,  0.00894242432 ,  0.00279541756 ,  0.00194747688 ,  0.0620145164 ,  0.0170855131 ,  0.0181015283 ,  -0.00488511659 ,  0.00739530521 ,  0.00381793058 ,  0.0236838441 ,  -0.0110180546 ,  -0.00303233787 ,  0.0106252125 ,  0.0218523424 ,  0.0120258862 ,  -0.0238109063 ,  -0.0141544091 ,  -0.0117197642 ,  0.00142283749 ,  0.00749559887 ,  -0.01835653 ,  0.0109190186 ,  0.230248854 ,  0.00243706512 ,  -0.0191726219 ,  -0.0039915205 ,  0.00090481824 ,  0.0097334832 ,  0.0011603015 ,  0.0128068542 ,  0.0132220108 ,  0.00675814971 ,  -0.00593760097 ,  -0.00415971177 ,  -0.00962787 ,  -0.00549635105 ,  0.00823726878 ,  0.0050871023 ,  -0.0110829314 ,  -0.0240769703 ,  0.0216759592 ,  0.0105546387 ,  0.0092127258 ,  0.00950946938 ,  0.011214288 ,  0.0207515862 ,  -0.00427346211 ,  0.0215848032 ,  0.00631247042 ,  -0.0173860975 ,  -0.00429316331 ,  -0.0156703293 ,  0.0145311896 ,  0.00154955836 ,  0.029202221 ,  0.00952351093 ,  0.00762017304 ,  0.0132371243 ,  -0.000413324917 ,  -0.018139435 ,  -0.00137031218 ,  -0.0247978102 ,  0.00110339699 ,  -0.0127050383 ,  0.00427115569 ,  0.0105016418 ,  0.00707798311 ,  0.00346998381 ,  0.0103705777 ,  -0.00652977 ,  -0.00415032031 ,  -0.02806486 ,  -0.00196650578 ,  -0.00155976182 ,  0.00992677 ,  -0.00105549069 ,  0.0137296533 ,  0.0236347523 ,  0.00182458689 ,  0.0199223049 ,  -0.00276026176 ,  0.00998133142 ,  0.0146578802 ,  0.019509837 ,  0.0132354666 ,  0.016197456 ,  -0.0222785398 ,  0.0275361184 ,  -0.00708267 ,  0.00204956881 ,  -0.0148065751 ,  -0.0156063633 ,  0.00459486898 ,  0.0315569416 ,  -0.0123368967 ,  0.000550252618 ,  0.0112896077 ,  0.0101433489 ,  0.0137203485 ,  -0.0309543014 ,  -0.0102090118 ,  -0.0146470396 ,  -0.0152495811 ,  -0.00782251731 ,  -0.000481927331 ,  0.00249194936 ,  0.0247710273 ,  -0.0138575658 ,  -0.00127112528 ,  -0.0101131462 ,  -0.0206313506 ,  0.0304280054 ,  -0.00248918636 ,  0.0173521303 ,  0.00556982402 ,  0.00141715049 ,  -0.00190233544 ,  0.0123170558 ,  0.0233307444 ,  0.00312000071 ,  0.00893271156 ,  -0.00211704732 ,  -0.0223851744 ,  -0.012003378 ,  -0.00173906132 ,  -0.033930853 ,  -0.0132441921 ,  0.00660338392 ,  -0.00732988073 ,  0.0382183567 ,  0.0115636932 ,  -0.00888128299 ,  0.00235293456 ,  0.015075597 ,  0.00542440079 ,  -0.00468811532 ,  0.00985751394 ,  -0.0152464211 ,  -0.0179700833 ,  0.0264063235 ,  0.0013880292 ,  -0.0310891103 ,  -0.00859554764 ,  0.0131274536 ,  -0.0163813084 ,  0.00150359748 ,  -0.0189019889 ,  0.017225489 ,  -0.00493983 ,  0.0150729371 ,  -0.00679251924 ,  -0.0257455166 ,  -0.0165748503 ,  -0.00722624 ,  -0.00870564487 ,  -0.00937411375 ,  -0.00884327 ,  -0.00593924755 ,  0.0273168385 ,  0.00984810665 ,  -0.00478853 ,  0.00960565172 ,  0.00520327082 ,  0.0110894656 ,  0.0043701129 ,  -0.012798368 ,  0.0209687147 ,  0.00173782359 ,  -0.00601157593 ,  -0.0136476019 ,  0.0242128018 ,  0.0126717044 ,  0.0118195312 ,  0.0129737463 ,  -0.0229055211 ,  0.000690913934 ,  0.00551808765 ,  -0.00700541073 ,  0.00897676498 ,  0.0118167475 ,  0.00463432027 ,  0.00607711449 ,  0.00252673146 ,  -0.00303562544 ,  0.00487812655 ,  0.0325729102 ,  0.00728356885 ,  0.00073953392 ,  0.0265055709 ,  -0.000579640735 ,  0.0107898898 ,  0.0121998601 ,  -0.00714005716 ,  0.0078013367 ,  -0.00521270139 ,  0.0168101899 ,  0.0088647 ,  0.00999857578 ,  -0.00270523643 ,  0.0103866616 ,  -0.0269346833 ,  0.00911592133 ,  -0.00812651496 ,  -0.00206404645 ,  -0.025884686 ,  0.00912743341 ,  -0.00175872992 ,  -0.00991604198 ,  -0.0105091603 ,  0.000180510629 ,  0.00418163789 ,  0.0123867551 ,  0.0236539524 ,  0.00107925967 ,  -0.025238933 ,  0.00963406172 ,  0.00202377327 ,  -0.0114020761 ,  -0.0153827742 ,  -0.233063191 ,  0.00823930651 ,  0.0278516747 ,  0.00509003364 ,  -0.00586490473 ,  0.0193683915 ,  0.00820283 ,  -0.00357188215 ,  0.0268714819 ,  0.010479169 ,  0.0107392 ,  -0.0155000668 ,  0.00263407873 ,  0.00065870746 ,  0.0123836948 ,  0.00198982726 ,  0.00132350391 ,  0.0108083915 ,  0.0162774287 ,  0.0291505177 ,  -0.00716524059 ,  0.019510936 ,  0.010420735 ,  -0.0078454446 ,  0.00412600813 ,  0.222484067 ,  -0.0179173574 ,  0.00783126522 ,  0.0239261631 ,  0.0193766039 ,  -0.0161322337 ,  0.00684979092 ,  0.000586602953 ,  0.0130467732 ,  0.0358007923 ,  0.0269247554 ,  0.0153604094 ,  0.0151261631 ,  -0.00188700343 ,  -0.0430293642 ,  0.0189248 ,  0.02430127 ,  0.00555612473 ,  0.0119575197 ,  0.00771942968 ,  0.0176902339 ,  0.00583886588 ,  0.0116942478 ,  -0.00926405098 ,  0.00491529051 ,  0.0217139572 ,  0.00573335215 ,  -0.000804958807 ,  -0.0280170124 ,  0.00963724311 ,  0.00507564237 ,  0.0220594108 ,  0.0128042139 ,  -0.00127830007 ,  0.00259291125 ,  0.0103000822 ,  -0.0145079456 ,  0.0148036787 ,  -0.0105359266 ,  -0.00389395165 ,  0.0142206615 ,  0.0135824792 ,  0.00595895387 ,  0.0161511507 ,  0.232452959 ,  -0.000142555946 ,  0.000271107041 ,  -0.0238926113 ,  0.0259047505 ,  0.0106993951 ,  -0.000737730297 ,  0.00544273434 ,  -0.0127941575 ,  -0.00329739344 ,  0.0119100409 ,  -0.0142753571 ,  -0.0108688306 ,  0.00695010647 ,  -0.0138504179 ,  -0.00906034093 ,  0.0275518447 ,  0.0196045041 ,  -0.00615167757 ,  -0.00447422592 ,  0.0149298692 ,  -0.00664616656 ,  0.0058194031 ,  0.00575606152 ,  0.0144092711 ,  0.000867464871 ,  0.0178548153 ,  -0.0210043751 ,  0.00154653843 ,  0.0130040636 ,  0.0133344783 ,  0.0210689399 ,  -0.000798698107 ,  0.0169157814 ,  -0.0211629048 ,  0.005026937 ,  -0.00688200723 ,  0.0141195403 ,  0.00194833172 ,  -0.252283752 ,  -0.00496839592 ,  -0.0271510147 ,  -0.0269647278 ,  0.0011925943 ,  -0.00528299622 ,  0.0144576477 ,  0.000428500032 ,  0.194181517 ,  0.00120390451 ,  0.0186372641 ,  -0.00348009216 ,  -0.0250063483 ,  0.0111154262 ,  0.0238689296 ,  0.0344107933 ,  -0.00657161698 ,  0.0185912456 ,  -0.0111957164 ,  0.0239445083 ,  0.0103179496 ,  -0.00954331364 ,  0.00209623878 ,  -0.0154177193 ,  0.00399070745 ,  -0.0194557216 ,  0.0299478099 ,  -0.0170003455 ,  -0.00423035165 ,  0.00587320467 ,  0.00796341058 ,  -0.00533772586 ,  -0.248399302 ,  0.00699611707 ,  0.0210152119 ,  0.00201326329 ,  -0.00507608615 ,  -0.000718786905 ,  0.00656326115 ,  0.00659298338 ,  -0.000534767867 ,  -0.000965561543 ,  0.0184912439 ,  0.0121826055 ,  0.0243660659 ,  -0.0246042833 ,  0.00656386279 ,  -0.251107365 ,  0.00962331798 ,  -0.00142832671 ,  -0.00682493858 ,  -0.0102992058 ,  0.0318381 ,  0.0140759088 ,  -0.00792997237 ,  0.00992488116 ,  0.0159473531 ,  -0.00444503687 ,  0.0184682291 ,  0.017080579 ,  0.00362053 ,  -0.0146627109 ,  -0.00403425889 ,  0.00717000104 ,  -0.00611356599 ,  0.0233313721 ,  -0.0000191460767 ,  0.00184973946 ,  -0.0221430436 ,  0.00678605726 ,  0.0109037785 ,  0.0074805771 ,  -0.00145827222 ,  0.00939664524 ,  -0.0191412829 ,  -0.0105937077 ,  -0.0203552675 ,  -0.000773178705 ,  0.0147816595 ,  -0.00293966336 ,  0.00826846436 ,  0.00837803818 ,  -0.00101526314 ,  -0.00273553329 ,  0.0101266494 ,  -0.001673689 ,  0.0188849866 ,  -0.00579562318 ,  -0.00269100559 ,  0.0139123229 ,  0.0112447571 ,  0.0129238544 ,  0.00298438338 ,  -0.003334234 ,  -0.00305852038 ,  0.0393794663 ,  -0.00390231446 ,  -0.00732593611 ,  -0.0110708829 ,  -0.00361443846 ,  0.017583428 ,  -0.00718549918 ,  -0.0101442989 ,  0.0065733823 ,  0.0142287426 ,  -0.0144060105 ,  0.00344274659 ,  -0.0119144674 ,  -0.0250328835 ,  0.00977446232 ,  -0.0151946703 ,  0.000556509 ,  0.0120263537 ,  0.0082664974 ,  0.000492535 ,  -0.00991211366 ,  -0.0231444649 ,  0.00153488165 ,  -0.0052031083 ,  -0.00942852534 ,  0.00826752093 ,  -0.00482423091 ,  0.00424786424 ,  0.017576132 ,  0.0120774219 ,  -0.0326001756 ,  -0.00969811715 ,  0.029474657 ,  0.0119578587 ,  -0.0031990048 ,  -0.0134235388 ,  -0.00780537 ,  0.0195534639 ,  -0.0083468128 ,  0.0167794749 ,  0.0110201519 ,  -0.00678452477 ,  0.0359834693 ,  0.00414798083 ,  -0.00200532866 ,  0.00184809917 ,  -0.00298899389 ,  0.000270740275 ,  -0.0126912016 ,  -0.0166389067 ,  0.00333408779 ,  -0.0122501981 ,  0.0221671369 ,  0.0151061174 ,  0.00304372516 ,  0.0100959325 ,  -0.00467099808 ,  0.0188763589 ,  0.00374847348 ,  -0.0058837696 ,  0.0305340886 ,  0.00531517901 ,  -0.0162042547 ,  -0.00144578575 ,  -0.0150523717 ,  -0.0107740369 ,  0.019592585 ,  0.0282917749 ,  -0.0261388607 ,  -0.0104051903 ,  0.0102958074 ,  0.0109012872 ,  0.0120215379 ,  0.0122558093 ,  0.0160539318 ,  0.000855114136 ,  -0.0187473483 ,  -0.00864194054 ,  -0.00797920395 ,  -0.0267480165 ,  0.0124802077 ,  0.0150261708 ,  0.00829137862 ,  0.00437135482 ,  0.00774782 ,  0.0332311727 ,  0.0136966566 ,  0.00591752492 ,  -0.012198546 ,  0.0205642898 ,  0.0185321 ,  0.0103255874 ,  0.0108888196 ,  0.00530302478 ,  0.00643242383 ,  0.00161989743 ,  0.00333637255 ,  0.0126080802 ,  0.0121926358 ,  0.0272572972 ,  0.0189470444 ,  0.00643786741 ,  0.0146671822 ,  -0.0115446849 ,  0.0160693377 ,  0.00702429609 ,  -0.0110485144 ,  -0.00256681 ,  -0.0121004796 ,  0.0154860076 ,  0.0217484739 ,  0.00479157455 ,  0.00916166138 ,  0.00520737376 ,  0.0295828115 ,  0.0215843525 ,  0.0139442133 ,  0.00587165263 ,  -0.0629038811 ,  0.0089202309 ,  -0.00977275148 ,  -0.00215260568 ,  0.0276353694 ,  0.0156865902 ,  0.00255307183 ,  0.0254296176 ,  0.00365543528 ,  -0.0057183858 ,  0.00900592748 ,  0.0107010705 ,  0.00631309114 ,  -0.0148108741 ,  0.0128395287 ,  -0.00277325674 ,  0.0152730336 ,  0.0142901326 ,  0.0194778983 ,  -0.00394276483 ,  0.00969220325 ,  0.00726978621 ,  -0.00968333054 ,  0.00766262319 ,  0.000700654055 ,  0.0132916747 ,  -0.00595067861 ,  0.00508601451 ,  0.00437385915 ,  0.0357413851 ,  -0.0143224932 ,  -0.0150837479 ,  0.00032923551 ,  -0.00152578694
],
        path: "embeddings",
        numCandidates: 100,       // Number of nearest neighbors to use during the search.
        index: "vectorsearch",
        limit: 100,               // Number of documents to return in the results. Value can't exceed the value of numCandidates.
      }
    }
  ];

  const books = await collections?.books?.aggregate(aggregationPipeline).toArray() as Book[];
  return books;
}
    public async createBook(book: Book): Promise<InsertOneResult> {
        const result = await collections?.books?.insertOne(book);

        if (!result?.insertedId) {
            throw new Error(this.errors.UNKNOWN_INSERT_ERROR);
        }

        return result;
    }

    public async updateBook(bookId: string, book: Book): Promise<UpdateResult> {
        const result = await collections?.books?.updateOne({ _id: bookId }, { $set: book });

        if (result.modifiedCount === 0) {
            throw new Error(this.errors.UNKNOWN_UPDATE_ERROR);
        }

        return result;
    }

    public async deleteBook(bookId: string): Promise<DeleteResult> {
        const result = await collections?.books?.deleteOne({ _id: bookId });

        if (result.deletedCount === 0) {
            throw new Error(this.errors.UNKNOWN_UPDATE_ERROR);
        }

        if (!result) {
            throw new Error(this.errors.UNKNOWN_DELETE_ERROR);
        }

        return result;
    }

    public incrementBookInventory(bookId: string, count: number = 1): Promise<UpdateResult> {
        return this.updateBookInventory(bookId, count);
    }

    public decrementBookInventory(bookId: string, count: number = 1): Promise<UpdateResult> {
        return this.updateBookInventory(bookId, -count);
    }

    public async isBookAvailable(bookId: string): Promise<Book> {
        const bookData = await this.getBook(bookId);

        if (!bookData) {
            throw new Error(this.errors.NOT_FOUND);
        }

        if (bookData?.available <= 0) {
            throw new Error(this.errors.NOT_AVAILABLE);
        }

        return bookData;
    }

    private updateBookInventory(bookId: string, count: number): Promise<UpdateResult> {
        const result = collections?.books?.updateOne(
            { _id: bookId },
            { $inc: { available: count } }
        );
        return result;
    }
}

export default BookController;
